<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Video Spell Checker</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #f4f6fb; --card: #ffffff; --primary: #1d6be5; --primary-light: #e8f0fe;
      --text: #1a1a2e; --muted: #6b7280; --border: #e5e7eb;
      --success: #16a34a; --success-bg: #f0fdf4;
      --error: #dc2626; --error-bg: #fef2f2;
      --radius: 14px; --shadow: 0 2px 12px rgba(0,0,0,0.07);
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding: 40px 16px 80px; }
    .container { max-width: 720px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 36px; }
    header .logo { font-size: 44px; margin-bottom: 8px; }
    header h1 { font-size: 26px; font-weight: 800; letter-spacing: -0.5px; }
    header p { color: var(--muted); margin-top: 6px; font-size: 15px; }
    .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 28px; margin-bottom: 20px; }
    #dropzone { border: 2.5px dashed var(--border); border-radius: 12px; padding: 48px 24px; text-align: center; cursor: pointer; transition: border-color 0.2s, background 0.2s; position: relative; }
    #dropzone:hover, #dropzone.drag-over { border-color: var(--primary); background: var(--primary-light); }
    #dropzone input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    #dropzone .dz-icon { font-size: 48px; margin-bottom: 12px; display: block; }
    #dropzone .dz-title { font-size: 16px; font-weight: 600; }
    #dropzone .dz-hint { font-size: 13px; color: var(--muted); margin-top: 4px; }
    #dropzone .dz-file { font-size: 14px; font-weight: 600; color: var(--primary); margin-top: 10px; }
    #uploadBtn { display: block; width: 100%; margin-top: 18px; padding: 14px; background: var(--primary); color: #fff; border: none; border-radius: 10px; font-size: 15px; font-weight: 700; cursor: pointer; transition: opacity 0.2s, transform 0.1s; }
    #uploadBtn:hover:not(:disabled) { opacity: 0.9; transform: translateY(-1px); }
    #uploadBtn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
    #progressSection { display: none; }
    .progress-label { display: flex; justify-content: space-between; font-size: 13px; color: var(--muted); margin-bottom: 8px; }
    .progress-bar-wrap { background: var(--border); border-radius: 99px; height: 8px; overflow: hidden; }
    .progress-bar-fill { height: 100%; border-radius: 99px; background: var(--primary); transition: width 0.4s ease; width: 0%; }
    .progress-steps { margin-top: 16px; display: flex; flex-direction: column; gap: 8px; }
    .step-item { display: flex; align-items: center; gap: 10px; font-size: 13px; color: var(--muted); }
    .step-item.active { color: var(--text); font-weight: 600; }
    .step-item.done { color: var(--success); }
    .step-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); flex-shrink: 0; }
    .step-item.active .step-dot { background: var(--primary); }
    .step-item.done .step-dot { background: var(--success); }
    .spinner { width: 18px; height: 18px; border: 2.5px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; flex-shrink: 0; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #resultsSection { display: none; }
    .result-badge { display: inline-flex; align-items: center; gap: 8px; padding: 6px 14px; border-radius: 99px; font-size: 13px; font-weight: 700; margin-bottom: 18px; }
    .result-badge.ok { background: var(--success-bg); color: var(--success); }
    .result-badge.fail { background: var(--error-bg); color: var(--error); }
    .stats-row { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-box { flex: 1; min-width: 120px; background: var(--bg); border-radius: 10px; padding: 12px 16px; }
    .stat-box .val { font-size: 22px; font-weight: 800; }
    .stat-box .lbl { font-size: 11px; color: var(--muted); margin-top: 2px; }
    .section-title { font-size: 14px; font-weight: 700; margin-bottom: 10px; }
    .error-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .error-table th { text-align: left; padding: 8px 12px; background: var(--bg); color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--border); }
    .error-table td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
    .error-table tr:last-child td { border-bottom: none; }
    .error-table tr:hover td { background: var(--bg); }
    .tag-error { display: inline-block; background: var(--error-bg); color: var(--error); font-weight: 700; padding: 2px 8px; border-radius: 6px; font-size: 12px; }
    .tag-fix { display: inline-block; background: var(--success-bg); color: var(--success); font-weight: 600; padding: 2px 8px; border-radius: 6px; font-size: 12px; }
    .transcript-section { margin-top: 20px; }
    .transcript-toggle { background: none; border: 1px solid var(--border); border-radius: 8px; padding: 7px 14px; font-size: 13px; cursor: pointer; color: var(--muted); }
    .transcript-toggle:hover { background: var(--bg); }
    #transcriptBody { display: none; margin-top: 12px; }
    .transcript-row { display: flex; gap: 14px; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
    .transcript-row:last-child { border-bottom: none; }
    .ts-time { color: var(--primary); font-weight: 600; flex-shrink: 0; width: 40px; }
    #resetBtn { display: none; margin-top: 16px; background: none; border: 1px solid var(--border); border-radius: 10px; padding: 10px 20px; font-size: 14px; cursor: pointer; color: var(--muted); }
    #resetBtn:hover { background: var(--bg); }
    #errorAlert { display: none; margin-top: 16px; background: var(--error-bg); color: var(--error); border-radius: 10px; padding: 14px 18px; font-size: 14px; }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo">üé¨</div>
    <h1>Video Spell Checker</h1>
    <p>Upload a video and AI will scan every frame for spelling errors in on-screen text.</p>
  </header>

  <div class="card" id="uploadCard">
    <div id="dropzone">
      <input type="file" id="fileInput" accept="video/*" />
      <span class="dz-icon">üìπ</span>
      <div class="dz-title">Drag &amp; drop a video, or click to browse</div>
      <div class="dz-hint">MP4, MOV, AVI, MKV &nbsp;¬∑&nbsp; Max 500 MB</div>
      <div class="dz-file" id="fileName"></div>
    </div>
    <button id="uploadBtn" disabled>Check for Spelling Errors</button>
    <div id="errorAlert"></div>
  </div>

  <div class="card" id="progressSection">
    <div class="progress-label">
      <span id="progressStep">Starting‚Ä¶</span>
      <span id="progressPct">0%</span>
    </div>
    <div class="progress-bar-wrap"><div class="progress-bar-fill" id="progressFill"></div></div>
    <div class="progress-steps" id="progressSteps">
      <div class="step-item active" id="stepExtract"><div class="spinner"></div><span>Extracting frames from video</span></div>
      <div class="step-item" id="stepAnalyse"><div class="step-dot"></div><span>Analysing frames with AI</span></div>
      <div class="step-item" id="stepReport"><div class="step-dot"></div><span>Compiling spell-check report</span></div>
    </div>
  </div>

  <div class="card" id="resultsSection">
    <div id="resultBadge"></div>
    <div class="stats-row" id="statsRow"></div>
    <div id="errorsBlock"></div>
    <div class="transcript-section">
      <button class="transcript-toggle" onclick="toggleTranscript()">üìÑ View full on-screen text transcript</button>
      <div id="transcriptBody"></div>
    </div>
    <button id="resetBtn" onclick="resetApp()">‚Ü© Check another video</button>
  </div>
</div>

<script>
  const fileInput=document.getElementById('fileInput'),dropzone=document.getElementById('dropzone'),fileName=document.getElementById('fileName'),uploadBtn=document.getElementById('uploadBtn'),uploadCard=document.getElementById('uploadCard'),progressSec=document.getElementById('progressSection'),resultsSec=document.getElementById('resultsSection'),errorAlert=document.getElementById('errorAlert'),resetBtn=document.getElementById('resetBtn');
  let selectedFile=null,pollTimer=null;

  fileInput.addEventListener('change',()=>{ if(fileInput.files.length) setFile(fileInput.files[0]); });
  dropzone.addEventListener('dragover',e=>{ e.preventDefault(); dropzone.classList.add('drag-over'); });
  dropzone.addEventListener('dragleave',()=>dropzone.classList.remove('drag-over'));
  dropzone.addEventListener('drop',e=>{ e.preventDefault(); dropzone.classList.remove('drag-over'); if(e.dataTransfer.files.length) setFile(e.dataTransfer.files[0]); });

  function setFile(file){ selectedFile=file; fileName.textContent=`üìé ${file.name} (${(file.size/1024/1024).toFixed(1)} MB)`; uploadBtn.disabled=false; }

  uploadBtn.addEventListener('click',startUpload);
  async function startUpload(){
    if(!selectedFile) return;
    errorAlert.style.display='none'; uploadBtn.disabled=true; uploadBtn.textContent='Uploading‚Ä¶';
    const fd=new FormData(); fd.append('video',selectedFile);
    try{
      const res=await fetch('/upload',{method:'POST',body:fd}); const data=await res.json();
      if(data.error) throw new Error(data.error);
      uploadCard.style.display='none'; progressSec.style.display='block'; pollStatus(data.job_id);
    }catch(err){ uploadBtn.disabled=false; uploadBtn.textContent='Check for Spelling Errors'; showError(err.message||'Upload failed.'); }
  }

  function pollStatus(jobId){
    pollTimer=setInterval(async()=>{
      try{
        const res=await fetch(`/status/${jobId}`); const data=await res.json();
        updateProgress(data.progress);
        if(data.status==='done'){ clearInterval(pollTimer); showResults(data.results); }
        else if(data.status==='error'){ clearInterval(pollTimer); progressSec.style.display='none'; uploadCard.style.display='block'; showError(data.error||'Processing failed.'); uploadBtn.disabled=false; uploadBtn.textContent='Check for Spelling Errors'; }
      }catch(_){}
    },1500);
  }

  function updateProgress(p){
    if(!p) return;
    const pct=p.pct||0;
    document.getElementById('progressFill').style.width=pct+'%';
    document.getElementById('progressStep').textContent=p.step||'';
    document.getElementById('progressPct').textContent=pct+'%';
    const se=document.getElementById('stepExtract'),sa=document.getElementById('stepAnalyse'),sr=document.getElementById('stepReport');
    if(pct>=10&&pct<95){ markDone(se); markActive(sa); }
    else if(pct>=95){ markDone(se); markDone(sa); markActive(sr); }
  }
  function markDone(el){ el.classList.remove('active'); el.classList.add('done'); const d=el.querySelector('.spinner,.step-dot'); if(d){ d.outerHTML='<div class="step-dot" style="background:var(--success)"></div>'; } }
  function markActive(el){ if(el.classList.contains('done')) return; el.classList.add('active'); const d=el.querySelector('.step-dot'); if(d) d.outerHTML='<div class="spinner"></div>'; }

  function showResults(results){
    progressSec.style.display='none'; resultsSec.style.display='block'; resetBtn.style.display='inline-block';
    const errors=results.errors||[];
    document.getElementById('resultBadge').innerHTML=errors.length===0?'<span class="result-badge ok">‚úÖ No spelling errors found!</span>':`<span class="result-badge fail">‚ùå ${errors.length} spelling error${errors.length>1?'s':''} found</span>`;
    document.getElementById('statsRow').innerHTML=`<div class="stat-box"><div class="val">${results.total_frames}</div><div class="lbl">Frames scanned</div></div><div class="stat-box"><div class="val">${results.frames_with_text}</div><div class="lbl">Frames with text</div></div><div class="stat-box"><div class="val" style="color:${errors.length?'var(--error)':'var(--success)'}">${errors.length}</div><div class="lbl">Spelling errors</div></div>`;
    const eb=document.getElementById('errorsBlock');
    if(errors.length>0){
      eb.innerHTML=`<div class="section-title">‚ö†Ô∏è Errors found</div><table class="error-table"><thead><tr><th>Time</th><th>Misspelled</th><th>Suggestion</th><th>Context</th></tr></thead><tbody>${errors.map(e=>`<tr><td>${e.timestamp}</td><td><span class="tag-error">${esc(e.word)}</span></td><td>${e.suggestion?`<span class="tag-fix">${esc(e.suggestion)}</span>`:'<span style="color:var(--muted)">‚Äî</span>'}</td><td style="color:var(--muted);font-size:12px">${esc(e.context||'')}</td></tr>`).join('')}</tbody></table>`;
    } else { eb.innerHTML=''; }
    const tb=document.getElementById('transcriptBody'),transcript=results.transcript||[];
    tb.innerHTML=transcript.length?transcript.map(t=>`<div class="transcript-row"><span class="ts-time">${t.timestamp}</span><span>${esc(t.text)}</span></div>`).join(''):'<p style="color:var(--muted);font-size:13px;padding:8px 0">No on-screen text detected.</p>';
  }

  function toggleTranscript(){ const b=document.getElementById('transcriptBody'); b.style.display=b.style.display==='none'?'block':'none'; }
  function showError(msg){ errorAlert.textContent='‚ö†Ô∏è '+msg; errorAlert.style.display='block'; }
  function resetApp(){
    clearInterval(pollTimer); selectedFile=null; fileInput.value=''; fileName.textContent=''; uploadBtn.disabled=true; uploadBtn.textContent='Check for Spelling Errors';
    errorAlert.style.display='none'; resultsSec.style.display='none'; progressSec.style.display='none'; uploadCard.style.display='block'; resetBtn.style.display='none';
    document.getElementById('progressFill').style.width='0%';
  }
  function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
</script>
</body>
</html>
